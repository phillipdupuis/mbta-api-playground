{% extends 'core/base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block content %}
{% include "core/modal.html" %}
<div class="modal fade" id="editColumnsModal" tabindex="-1" role="dialog" aria-labelledby="editColumnsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editColumnsModalLabel">Columns displayed</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul id="columns_displayed">
                    {% for column in results.df.columns %}
                    <li>
                        <input class="form-check-input" type="checkbox" id="{{ column }}" value="{{ column }}">
                        <label class="form-check-label" for="{{ column }}">{{ column }}</label>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editColumnsModalSaveButton" data-dismiss="modal">Save changes</button>
            </div>
        </div>
    </div>
</div>
{% if results.error %}
<p>{{ results.error }}</p>
<p>{{ results.error_detail }}</p>
{% elif results.data_frame.empty %}
<p>No data</p>
{% else %}
<!-- navbar -->
<ul class="nav nav-tabs" id="resultTab" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" data-toggle="tab" href="#summary" id="id_tab_summary" role="tab" aria-controls="summary" aria-selected="true">Summary</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#full-table" id="id_tab_table" role="tab" aria-controls="full-table" aria-selected="false">Table</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#raw-data" id="id_tab_raw_data" role="tab" aria-controls="raw-data" aria-selected="false">JSON</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#graphs" id="id_tab_graphs" role="tab" aria-controls="graphs" aria-selected="false">Plots</a>
    </li>
</ul>
<!-- tab panes -->
<div class="tab-content my-3">
    <!-- summary -->
    <div class="tab-pane active p-3" id="summary" role="tabpanel" aria-labelledby="id_tab_summary">
        <dl class="row">
            <dt class="col-sm-3">URL</dt>
            <dd class="col-sm-9">{{ results.response.url|urlizetrunc:100 }}</dd>
            <dt class="col-sm-3">Response size</dt>
            <dd class="col-sm-9">{{ results.response_size_bytes|filesizeformat }}</dd>
            <dt class="col-sm-3">Primary Object</dt>
            <dd class="col-sm-9">{{ query.primary_object }}</dd>
            {% if query.includes.all.count > 0 %}
            <dt class="col-sm-3">Includes</dt>
            <dd class="col-sm-9">{{ query.includes.all|join:", " }}</dd>
            {% endif %}
            <dt class="col-sm-3">Attributes</dt>
            <dd class="col-sm-9">{{ query.attributes.all|join:", " }}</dd>
        </dl>
    </div>
    <!-- full table -->
    <div class="tab-pane p-3" id="full-table" role="tabpanel" aria-labelledby="id_tab_table">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group mr-2">
                    <a href="{% url 'queries:results-csv' query.pk %}" class="btn btn-sm btn-secondary" role="button">Export to CSV</a>
                </div>
                <button type="button" class="btn btn-sm btn-secondary" id="edit_columns_button">Edit columns displayed</button>
            </div>
        </div>
        <div class="flex-grow-1">
            <div class="table-responsive" style="max-height:66vh;overflow-y:auto;">
                <table class="table table-sm table-striped">
                    <thead class="thead-light sticky-top">
                        <tr class="sticky-top">
                            {% for col in results.df.columns %}
                                <th scope="col" id="{{ col }}" class="sticky-top">{{ col }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in results.data_frame_rows %}
                        <tr id="{{ row.id }}">
                            {% for cell in row.cells %}
                                <td id="{{ cell.row_id }}|{{ cell.col_id }}">
                                    {{ cell.value }}
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- raw data -->
    <div class="tab-pane p-3" id="raw-data" role="tabpanel" aria-labelledby="id_tab_raw_data">
        <pre>{{ results.pretty_json }}</pre>
    </div>
    <!-- graphs -->
    <div class="tab-pane p-3" id="graphs" role="tabpanel" aria-labelledby="id_tab_graphs">
        <div class="col-md-8 align-items-center" id="id_graphs">
            <div class="card">
                <div class="card-header">
                    <form action="" id="graph_form" method="post">{% csrf_token %}
                        <div class="form-group row">
                            <label for="graph_type" class="col-sm-2 col-form-label">Type</label>
                            <div class="col-sm-10">
                                <select class="form-control" id="graph_type">
                                    {% for k, v in results.plot_params.types.items %}
                                    <option value="{{ k }}">{{ v|title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="graph_x" class="col-sm-2 col-form-label">X-axis</label>
                            <div class="col-sm-10">
                                <select class="form-control" id="graph_x"></select>
                            </div>
                        </div>
                        <button type="submit" class="save btn btn-primary" id="create_graph_btn" data-endpoint="{% url 'queries:results' pk=query.pk %}create_graph/">Create</button>
                    </form>
                </div>
                <div class="card-body" id="graph_container"></div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock content %}
{% block extrascripts %}
<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-1.3.4.min.js"></script>
<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-widgets-1.3.4.min.js"></script>
{{ results.plot_params|json_script:"plot_params" }}
<script type="module" src="{% static 'js/results/graphs.js' %}"></script>
<script type="module" src="{% static 'js/results/table.js' %}"></script>
{% endblock extrascripts %}